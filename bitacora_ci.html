<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bitácora de Actividad – TR ACCESORIOS</title>
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/sweetalert2.css" />
  <link rel="stylesheet" href="css/material.min.css" />
  <link rel="stylesheet" href="css/material-design-iconic-font.min.css" />
  <link rel="stylesheet" href="css/jquery.mCustomScrollbar.css" />
  <link rel="stylesheet" href="css/main.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="js/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="js/main.js"></script>
</head>

<body>
  <!-- Navbar -->
  <div class="full-width navBar">
    <div class="full-width navBar-options">
      <i class="zmdi zmdi-more-vert btn-menu" id="btn-menu"></i>
      <nav class="navBar-options-list">
        <ul class="list-unstyle">
          <li class="btn-exit" onclick="logout()"><i class="zmdi zmdi-power"></i></li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Barra lateral -->
  <section class="full-width navLateral">
    <div class="full-width navLateral-bg btn-menu"></div>
    <div class="full-width navLateral-body">
      <div class="full-width navLateral-body-logo text-center tittles">
        <i class="zmdi zmdi-close btn-menu"></i> TR ACCESORIOS
      </div>
      <figure class="full-width" style="height: 77px;">
        <div class="navLateral-body-cl">
          <img src="assets/img/logo.jpg" alt="Avatar" class="img-responsive" />
        </div>
        <figcaption class="navLateral-body-cr hide-on-tablet">
          <span>Usuario<br /><small>Rol</small></span>
        </figcaption>
      </figure>
      <div class="full-width tittles navLateral-body-tittle-menu">
        <i class="zmdi zmdi-desktop-mac"></i><span class="hide-on-tablet"> MENÚ</span>
      </div>
      <nav class="full-width">
        <ul class="full-width list-unstyle menu-principal">
        <li><a href="home_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-view-dashboard"></i></div><div class="navLateral-body-cr hide-on-tablet">Inicio</div></a></li>
          <li><a href="ventas_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-cart"></i></div><div class="navLateral-body-cr hide-on-tablet">Ventas</div></a></li>
          <li><a href="admin_ci.html" class="full-width active"><div class="navLateral-body-cl"><i class="zmdi zmdi-accounts-alt"></i></div><div class="navLateral-body-cr hide-on-tablet">Administradores</div></a></li>
		<li><a href="bitacora_ci.html" class="full-width active"><div class="navLateral-body-cl"><i class="zmdi zmdi-assignment"></i></div><div class="navLateral-body-cr hide-on-tablet">Bitácora</div></a></li>  
		  
        </ul>
      </nav>
    </div>
  </section>

  <!-- Contenido -->
  <section class="full-width pageContent">
    <div class="mdl-grid">
      <div class="mdl-cell mdl-cell--10-col mdl-cell--1-offset-desktop">
        <div class="full-width panel mdl-shadow--2dp">
          <div class="full-width panel-tittle bg-primary text-center tittles">Bitácora del sistema</div>
          <div class="full-width panel-content">
            <div style="margin-bottom:10px;">
              <input type="text" class="mdl-textfield__input" id="filtroCorreo" placeholder="Filtrar por correo..." style="width:32%;margin-right:5px;" />
              <input type="text" class="mdl-textfield__input" id="filtroModulo" placeholder="Filtrar por módulo..." style="width:32%;margin-right:5px;" />
              <input type="text" class="mdl-textfield__input" id="filtroAccion" placeholder="Filtrar por acción..." style="width:32%;" />
            </div>
            <ul class="mdl-list" id="listaBitacora">
              <!-- Registros cargados aquí -->
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Script principal -->
  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getDatabase, ref, onValue, get
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCE9UY3P3oEFZ_cgX7d5Ox0lFZiL_9Uszs",
  authDomain: "accesoriostr-7f01e.firebaseapp.com",
  databaseURL: "https://accesoriostr-7f01e-default-rtdb.firebaseio.com",
  projectId: "accesoriostr-7f01e",
  storageBucket: "accesoriostr-7f01e.firebasestorage.app",
  messagingSenderId: "927871540022",
  appId: "1:927871540022:web:eb4a9a446cc0a6530a7197"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    window.logout = function () {
      signOut(auth).then(() => window.location.href = "index.html");
    };

    // Validación de acceso solo para admin
    onAuthStateChanged(auth, user => {
  if (!user) return window.location.href = "index.html";
  const uid = user.uid;
  get(ref(db, "usuarios/" + uid)).then(snap => {
    const datos = snap.val();
    if (!datos || datos.rol !== "admin") {
      Swal.fire("Acceso denegado", "Solo para administradores", "error")
        .then(() => window.location.href = "home_ci.html");
      return;
    }

    // Mostrar correo y rol en menú
    document.querySelectorAll(".navLateral-body-cr span").forEach(el => {
      el.innerHTML = `${user.email}<br><small>${datos.rol}</small>`;
    });

    // Solicitar PIN de acceso
    Swal.fire({
      title: "Autenticación adicional",
      input: "password",
      inputLabel: "Ingresa el PIN de administrador",
      inputPlaceholder: "****",
      inputAttributes: { maxlength: 10, autocapitalize: "off", autocorrect: "off" },
      confirmButtonText: "Ingresar",
      showCancelButton: true
    }).then(result => {
      if (result.isConfirmed && result.value === "1004") {
        cargarBitacora(); // función que muestra los registros
      } else {
        Swal.fire("PIN incorrecto o cancelado", "", "error")
          .then(() => window.location.href = "home_ci.html");
      }
    });
  });
});

    // Bitácora en vivo
    const lista = document.getElementById("listaBitacora");
    const filtroCorreo = document.getElementById("filtroCorreo");
    const filtroModulo = document.getElementById("filtroModulo");
    const filtroAccion = document.getElementById("filtroAccion");
    let registros_ci = [];

    function cargarBitacora() {
  onValue(ref(db, "registros_ci"), snap => {
    const data = snap.val() || {};
    registros_ci = Object.values(data).sort((a, b) => b.fecha.localeCompare(a.fecha));
    renderBitacora();
  });
}


    [filtroCorreo, filtroModulo, filtroAccion].forEach(el => {
      el.addEventListener("input", renderBitacora);
    });

    function renderBitacora() {
      lista.innerHTML = "";
      const correo = filtroCorreo.value.toLowerCase();
      const modulo = filtroModulo.value.toLowerCase();
      const accion = filtroAccion.value.toLowerCase();

      registros_ci.forEach(r => {
        if (
          (correo && !r.correo.toLowerCase().includes(correo)) ||
          (modulo && !r.modulo.toLowerCase().includes(modulo)) ||
          (accion && !r.accion.toLowerCase().includes(accion))
        ) return;

        const li = document.createElement("li");
        li.className = "mdl-list__item";
        li.innerHTML = `
          <span class="mdl-list__item-primary-content">
            <strong>${r.accion}</strong> en <em>${r.modulo}</em><br>
            Por: ${r.correo} <small style="margin-left:10px;">${r.fecha.split("T")[0]} ${r.fecha.split("T")[1]?.slice(0,5) || ""}</small>
          </span>
        `;
        lista.appendChild(li);
      });
    }
  </script>
  <script>
  $(window).on("load", function () {
    $(".navLateral-body, .pageContent").mCustomScrollbar({
      theme: "dark-thin",
      scrollbarPosition: "inside",
      autoHideScrollbar: true,
      scrollButtons: { enable: true }
    });
  });
</script>

</body>
</html>
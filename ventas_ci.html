<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ventas – TR ACCESORIOS (CI)</title>

  <!-- Estilos base -->
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/sweetalert2.css" />
  <link rel="stylesheet" href="css/material.min.css" />
  <link rel="stylesheet" href="css/material-design-iconic-font.min.css" />
  <link rel="stylesheet" href="css/jquery.mCustomScrollbar.css" />
  <link rel="stylesheet" href="css/main.css" />

  <!-- Scripts base -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>
    window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>');
  </script>
  <script src="js/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

<!-- NAV LATERAL -->
<section class="full-width navLateral">
  <div class="full-width navLateral-bg btn-menu"></div>

  <div class="full-width navLateral-body">
    <div class="full-width navLateral-body-logo text-center tittles">
      <i class="zmdi zmdi-close btn-menu"></i> TR ACCESORIOS – CI
    </div>

    <figure class="full-width" style="height:77px;">
      <div class="navLateral-body-cl">
        <img src="assets/img/logo.jpg" alt="Logo" />
      </div>
      <figcaption class="navLateral-body-cr hide-on-tablet">
        <span>Usuario<br><small>Centro Instalación</small></span>
      </figcaption>
    </figure>

    <div class="full-width tittles navLateral-body-tittle-menu">
      <i class="zmdi zmdi-desktop-mac"></i><span class="hide-on-tablet"> MENÚ</span>
    </div>

    <nav class="full-width">
      <ul class="full-width list-unstyle menu-principal">

        <li>
          <a href="home_ci.html" class="full-width">
            <div class="navLateral-body-cl"><i class="zmdi zmdi-view-dashboard"></i></div>
            <div class="navLateral-body-cr hide-on-tablet">Inicio</div>
          </a>
        </li>

        <li>
          <a href="inventory_ci.html" class="full-width">
            <div class="navLateral-body-cl"><i class="zmdi zmdi-store"></i></div>
            <div class="navLateral-body-cr hide-on-tablet">Inventario</div>
          </a>
        </li>

        <li>
          <a href="client_ci.html" class="full-width">
            <div class="navLateral-body-cl"><i class="zmdi zmdi-accounts"></i></div>
            <div class="navLateral-body-cr hide-on-tablet">Clientes</div>
          </a>
        </li>

        <li>
          <a href="sales_ci.html" class="full-width">
            <div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-basket"></i></div>
            <div class="navLateral-body-cr hide-on-tablet">Compras</div>
          </a>
        </li>

        <li>
          <a href="providers_ci.html" class="full-width">
            <div class="navLateral-body-cl"><i class="zmdi zmdi-truck"></i></div>
            <div class="navLateral-body-cr hide-on-tablet">Proveedores</div>
          </a>
        </li>

        <li>
          <a href="ventas_ci.html" class="full-width active">
            <div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-cart"></i></div>
            <div class="navLateral-body-cr hide-on-tablet">Ventas</div>
          </a>
        </li>

        <li>
          <a href="cuentas-cobrar_ci.html" class="full-width">
            <div class="navLateral-body-cl"><i class="zmdi zmdi-balance-wallet"></i></div>
            <div class="navLateral-body-cr hide-on-tablet">Cuentas por cobrar</div>
          </a>
        </li>

      </ul>
    </nav>
  </div>
</section>


<!-- NAV SUPERIOR -->
<div class="full-width navBar">
  <div class="full-width navBar-options">
    <i class="zmdi zmdi-more-vert btn-menu" id="btn-menu"></i>

    <nav class="navBar-options-list">
      <ul class="list-unstyle">
        <li class="btn-exit" onclick="logout()">
          <i class="zmdi zmdi-power"></i>
        </li>
      </ul>
    </nav>

  </div>
</div>


<!-- CONTENIDO PRINCIPAL -->
<section class="full-width pageContent">
  <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">

    <div class="mdl-tabs__tab-bar">
      <a href="#tabNewVenta" class="mdl-tabs__tab is-active">Registrar venta</a>
      <a href="#tabListVentas" class="mdl-tabs__tab">Historial de ventas</a>
    </div>


    <!-- PANEL: REGISTRAR NUEVA VENTA -->
    <div class="mdl-tabs__panel is-active" id="tabNewVenta">
      <div class="mdl-grid">
        <div class="mdl-cell mdl-cell--8-col mdl-cell--2-offset-desktop">
          <div class="full-width panel mdl-shadow--2dp">

            <div class="full-width panel-tittle bg-primary text-center tittles">
              Registrar nueva venta – CI
            </div>

            <div class="full-width panel-content">

              <form id="form-venta">

                <!-- Cliente -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <select id="ventaCliente" class="mdl-textfield__input">
                    <option value="">Selecciona un cliente</option>
                  </select>
                </div>

                <!-- Producto -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <select id="ventaProducto" class="mdl-textfield__input">
                    <option value="">Selecciona un producto</option>
                  </select>
                </div>

                <!-- Cantidad -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input type="number" id="ventaCantidad" class="mdl-textfield__input" />
                  <label class="mdl-textfield__label" for="ventaCantidad">Cantidad</label>
                </div>

                <!-- PRECIO MANUAL (agregado igual que ventas normal) -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input type="number" step="0.01" id="ventaPrecioManual" class="mdl-textfield__input" />
                  <label class="mdl-textfield__label" for="ventaPrecioManual">
                    Precio manual (opcional)
                  </label>
                </div>

                <p class="text-center">
                  <button id="btn-agregarCarrito"
                    class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                    Agregar al carrito
                  </button>
                </p>

              </form>


              <!-- TABLA DEL CARRITO -->
              <div class="mdl-cell mdl-cell--12-col">
                <h5 class="text-center">Carrito de venta</h5>

                <table class="mdl-data-table mdl-js-data-table full-width" id="tablaCarrito">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th>Cantidad</th>
                      <th>Precio unitario</th>
                      <th>Subtotal</th>
                      <th></th>
                    </tr>
                  </thead>

                  <tbody></tbody>

                  <tfoot>
                    <tr>
                      <td colspan="3"><strong>Total</strong></td>
                      <td id="ventaTotal">Q0.00</td>
                      <td></td>
                    </tr>
                  </tfoot>

                </table>
              </div>

              <p class="text-center">
                <button id="btn-finalizarVenta"
                  class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                  Finalizar venta
                </button>

                <button id="btn-trasladoCI"
                  class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"
                  style="margin-left:8px;">
                  Trasladar a Bodega Principal
                </button>
              </p>

            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- PANEL: HISTORIAL DE VENTAS -->
    <div class="mdl-tabs__panel" id="tabListVentas">
      <div class="mdl-grid">
        <div class="mdl-cell mdl-cell--10-col mdl-cell--1-offset-desktop">
          <div class="full-width panel mdl-shadow--2dp">

            <div class="full-width panel-tittle bg-success text-center tittles">
              Historial de ventas – CI
            </div>

            <div class="full-width panel-content">

              <!-- FILTRO -->
              <div style="margin-bottom: 10px; text-align:right;">
                <input type="text" id="filtroVenta" placeholder="Buscar venta..."
                  class="mdl-textfield__input"
                  style="width: 300px; padding: 8px;" />
              </div>

              <!-- TABLA HISTORIAL -->
              <table class="mdl-data-table mdl-js-data-table full-width" id="tablaHistorial">
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Fecha</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

            </div>
          </div>
        </div>
      </div>
    </div>


  </div>
</section>


<!-- MODAL EDITAR VENTA -->
<div id="modalEditarVenta"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,.5); z-index:9999; justify-content:center; align-items:center;">

  <div style="width: 350px; padding: 20px; background:#FFF; border-radius:8px;">
    <h4 class="text-center">Editar venta</h4>

    <input type="hidden" id="editVentaId">

    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
      <input type="number" id="editCantidad" class="mdl-textfield__input" />
      <label class="mdl-textfield__label" for="editCantidad">Cantidad</label>
    </div>

    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
      <input type="number" id="editPrecio" class="mdl-textfield__input" />
      <label class="mdl-textfield__label" for="editPrecio">Precio</label>
    </div>

    <p class="text-center">
      <button id="btnGuardarEdicion"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
        Guardar cambios
      </button>

      <button onclick="cerrarModalEditar()"
        class="mdl-button mdl-js-button mdl-button--raised"
        style="margin-left:8px;">
        Cancelar
      </button>
    </p>
  </div>

</div>


<!-- SCRIPTS FIREBASE -->
<script type="module">

/* ================================
   CONFIGURAR FIREBASE
=================================*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getDatabase, ref, onValue, push, update, remove
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCoK-r6GDcvllgFhu_S30u_lzLjaJj7bu8",
  authDomain: "tr-accesorios.firebaseapp.com",
  databaseURL: "https://tr-accesorios-default-rtdb.firebaseio.com",
  projectId: "tr-accesorios",
  storageBucket: "tr-accesorios.appspot.com",
  messagingSenderId: "652274227018",
  appId: "1:652274227018:web:2e07b64a44b6527ef77318",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);


/* ================================
   CARGAR CLIENTES
=================================*/
const clientesSelect = document.getElementById("ventaCliente");

onValue(ref(db, "clientes_ci"), (snap) => {
  clientesSelect.innerHTML = '<option value="">Selecciona un cliente</option>';

  snap.forEach((child) => {
    const c = child.val();
    clientesSelect.innerHTML += `
      <option value="${child.key}">${c.nombre}</option>
    `;
  });
});


/* ================================
   CARGAR PRODUCTOS
=================================*/
const productosSelect = document.getElementById("ventaProducto");

onValue(ref(db, "productos_ci"), (snap) => {
  productosSelect.innerHTML = '<option value="">Selecciona un producto</option>';

  snap.forEach((child) => {
    const p = child.val();
    productosSelect.innerHTML += `
      <option value="${child.key}">
        ${p.nombre} (Stock: ${p.cantidad})
      </option>
    `;
  });
});


/* ================================
   VARIABLES GENERALES
=================================*/
let carrito = [];


/* ================================
   FUNCION: AGREGAR AL CARRITO
=================================*/
document.getElementById("btn-agregarCarrito").addEventListener("click", (e) => {
  e.preventDefault();

  const cliente = document.getElementById("ventaCliente").value;
  const prodID = document.getElementById("ventaProducto").value;
  const cantidad = parseInt(document.getElementById("ventaCantidad").value);
  const precioManual = parseFloat(document.getElementById("ventaPrecioManual").value);

  if (!cliente || !prodID || !cantidad) {
    Swal.fire("Campos incompletos", "Debes llenar cliente, producto y cantidad.", "warning");
    return;
  }

  // Obtener producto seleccionado
  onValue(ref(db, "productos_ci/" + prodID), (snap) => {

    const prod = snap.val();
    if (!prod) return;

    if (cantidad > prod.cantidad) {
      Swal.fire("Stock insuficiente", "No hay suficiente inventario.", "warning");
      return;
    }

    // Determinar precio a usar
    let precioFinal = prod.precioSugerido;

    if (!isNaN(precioManual)) {

      // VALIDACIÓN PRECIOS
      if (precioManual < prod.precioTope) {

        Swal.fire({
          title: "Precio inferior al tope",
          html: `
            <p>Precio ingresado: <strong>Q${precioManual}</strong></p>
            <p>Precio tope: <strong>Q${prod.precioTope}</strong></p>
            <p>Precio sugerido: <strong>Q${prod.precioSugerido}</strong></p>
            <p>¿Deseas continuar?</p>
          `,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Sí, continuar",
          cancelButtonText: "No",
        }).then((r) => {
          if (r.isConfirmed) {
            agregarCarritoDefinitivo(prod, prodID, cantidad, precioManual);
          }
        });

        return;
      }

      precioFinal = precioManual;
    }

    agregarCarritoDefinitivo(prod, prodID, cantidad, precioFinal);

  }, { onlyOnce: true });
});


/* ================================
   FUNCION REAL: AGREGAR AL CARRITO
=================================*/
function agregarCarritoDefinitivo(prod, prodID, cantidad, precioFinal) {

  carrito.push({
    id: prodID,
    nombre: prod.nombre,
    cantidad: cantidad,
    precio: precioFinal,
  });

  actualizarTablaCarrito();

  document.getElementById("ventaCantidad").value = "";
  document.getElementById("ventaPrecioManual").value = "";
}
/* ================================
   ACTUALIZAR TABLA CARRITO
=================================*/
function actualizarTablaCarrito() {
  const tbody = document.querySelector("#tablaCarrito tbody");
  tbody.innerHTML = "";
  let total = 0;
  carrito.forEach((item, idx) => {
    const subtotal = Number(item.precio) * Number(item.cantidad);
    total += subtotal;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.nombre}</td>
      <td>${item.cantidad}</td>
      <td>Q${Number(item.precio).toFixed(2)}</td>
      <td>Q${subtotal.toFixed(2)}</td>
      <td>
        <button class="mdl-button mdl-js-button mdl-button--icon" onclick="quitarDelCarrito(${idx})">
          <i class="zmdi zmdi-delete"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById("ventaTotal").textContent = "Q" + total.toFixed(2);
}
window.quitarDelCarrito = (i) => {
  carrito.splice(i, 1);
  actualizarTablaCarrito();
};

/* ================================
   FINALIZAR VENTA (guardar en ventas_ci)
=================================*/
document.getElementById("btn-finalizarVenta").addEventListener("click", async () => {
  const cliente = document.getElementById("ventaCliente").value;
  if (!cliente) {
    Swal.fire("Selecciona cliente", "", "info");
    return;
  }
  if (carrito.length === 0) {
    Swal.fire("Carrito vacío", "Agrega al menos un producto", "warning");
    return;
  }

  // construir venta
  const venta = {
    cliente,
    fecha: new Date().toISOString().split("T")[0],
    total: carrito.reduce((s, p) => s + (p.precio * p.cantidad), 0),
    productos: carrito.map(p => ({ codigo: p.id, nombre: p.nombre, cantidad: p.cantidad, precio: p.precio }))
  };

  // guardar en ventas_ci
  const ventasRef = ref(db, "ventas_ci");
  const nuevaVentaRef = push(ventasRef);
  venta.codigo = "V" + (Date.now().toString().slice(-6)); // código simple único
  await set(nuevaVentaRef, venta).catch(err => {
    console.error(err);
    Swal.fire("Error", "No se pudo guardar la venta", "error");
  });

  // registrar en registros_ci (opcional)
  try {
    await push(ref(db, "registros_ci"), {
      fecha: new Date().toISOString(),
      accion: "Venta registrada",
      referencia: venta.codigo,
      detalle: { cliente: venta.cliente, total: venta.total }
    });
  } catch (e) { /* noop */ }

  // actualizar stock en productos_ci
  for (const p of venta.productos) {
    const prodRef = ref(db, "productos_ci/" + p.codigo);
    onValue(prodRef, (snap) => {
      const actual = snap.val();
      if (!actual) return;
      const nuevoStock = (Number(actual.cantidad) || 0) - Number(p.cantidad);
      update(prodRef, { cantidad: nuevoStock }).catch(()=>{});
    }, { onlyOnce: true });
  }

  carrito = [];
  actualizarTablaCarrito();
  Swal.fire("Venta registrada", `Código: ${venta.codigo}`, "success");
});

/* ================================
   TRASLADO (guardar en traslados_ci)
=================================*/
document.getElementById("btn-trasladoCI").addEventListener("click", async () => {
  if (carrito.length === 0) {
    Swal.fire("Carrito vacío", "Agrega al menos un producto para trasladar", "warning");
    return;
  }
  const traslado = {
    fecha: new Date().toISOString().split("T")[0],
    productos: carrito.map(p => ({ codigo: p.id, nombre: p.nombre, cantidad: p.cantidad })),
    estado: "pendiente",
    origen: "Bodega CI",
    destino: "Centro de instalación"
  };
  await push(ref(db, "traslados_ci"), traslado).catch(err => {
    console.error(err);
    Swal.fire("Error", "No se pudo crear el traslado", "error");
  });
  // restar stock
  for (const p of traslado.productos) {
    const prodRef = ref(db, "productos_ci/" + p.codigo);
    onValue(prodRef, (snap) => {
      const act = snap.val();
      if (!act) return;
      const nuevo = (Number(act.cantidad) || 0) - Number(p.cantidad);
      update(prodRef, { cantidad: nuevo }).catch(()=>{});
    }, { onlyOnce: true });
  }
  carrito = [];
  actualizarTablaCarrito();
  Swal.fire("Traslado registrado", "", "success");
});

/* ================================
   RENDERIZAR HISTORIAL (tablaHistorial)
=================================*/
const tablaHistorialBody = document.querySelector("#tablaHistorial tbody");
onValue(ref(db, "ventas_ci"), (snap) => {
  const all = snap.val() || {};
  tablaHistorialBody.innerHTML = "";
  Object.entries(all).forEach(([key, v]) => {
    (v.productos || []).forEach(prod => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${v.cliente}</td>
        <td>${prod.nombre}</td>
        <td>${prod.cantidad}</td>
        <td>Q${Number(prod.precio).toFixed(2)}</td>
        <td>${v.fecha}</td>
        <td>
          <button class="mdl-button mdl-js-button mdl-button--icon" onclick="abrirEditarVenta('${key}')">
            <i class="zmdi zmdi-edit"></i>
          </button>
          <button class="mdl-button mdl-js-button mdl-button--icon" onclick="imprimirVenta('${key}')">
            <i class="zmdi zmdi-print"></i>
          </button>
          <button class="mdl-button mdl-js-button mdl-button--icon" onclick="borrarVenta('${key}')">
            <i class="zmdi zmdi-delete"></i>
          </button>
        </td>
      `;
      tablaHistorialBody.appendChild(tr);
    });
  });
});

/* FILTRO SIMPLE */
document.getElementById("filtroVenta")?.addEventListener("input", (e) => {
  const q = e.target.value.trim().toLowerCase();
  const rows = tablaHistorialBody.querySelectorAll("tr");
  rows.forEach(r => {
    const text = r.innerText.toLowerCase();
    r.style.display = text.includes(q) ? "" : "none";
  });
});

/* ================================
   EDITAR VENTA (abrir modal)
=================================*/
window.abrirEditarVenta = async (ventaId) => {
  const ventaSnapRef = ref(db, "ventas_ci/" + ventaId);
  onValue(ventaSnapRef, (snap) => {
    const v = snap.val();
    if (!v) return;
    // para simplicidad aquí editamos el primer producto de la venta
    const primerProd = (v.productos && v.productos[0]) || null;
    if (!primerProd) {
      Swal.fire("No hay productos", "", "info");
      return;
    }
    document.getElementById("editVentaId").value = ventaId;
    document.getElementById("editCantidad").value = primerProd.cantidad;
    document.getElementById("editPrecio").value = Number(primerProd.precio).toFixed(2);
    document.getElementById("modalEditarVenta").style.display = "flex";
  }, { onlyOnce: true });
};

window.cerrarModalEditar = () => {
  document.getElementById("modalEditarVenta").style.display = "none";
  document.getElementById("editVentaId").value = "";
  document.getElementById("editCantidad").value = "";
  document.getElementById("editPrecio").value = "";
};

/* GUARDAR EDICIÓN: actualiza cantidad/precio del primer producto */
document.getElementById("btnGuardarEdicion").addEventListener("click", async () => {
  const id = document.getElementById("editVentaId").value;
  if (!id) return cerrarModalEditar();
  const nuevaCant = Number(document.getElementById("editCantidad").value);
  const nuevoPrecio = Number(document.getElementById("editPrecio").value);
  if (!nuevaCant || nuevaCant <= 0) {
    Swal.fire("Cantidad inválida", "", "warning");
    return;
  }
  const ventaRef = ref(db, "ventas_ci/" + id);
  onValue(ventaRef, async (snap) => {
    const v = snap.val();
    if (!v) return;
    const productos = v.productos || [];
    const primer = productos[0];
    if (!primer) return;
    // actualizar stock: devolver stock anterior y restar nuevo
    const prodRef = ref(db, "productos_ci/" + primer.codigo);
    const prodSnap = await new Promise(res => onValue(prodRef, s => res(s), { onlyOnce: true }));
    const actual = prodSnap.val() || {};
    const stockAntes = Number(actual.cantidad) || 0;
    // calcular: cuando venta original disminuyó stock en X, para editar:
    // restauramos el stock sumando la cantidad vendida originalmente, luego restamos la nueva cantidad
    const stockRestaurado = stockAntes + Number(primer.cantidad);
    const stockFinal = stockRestaurado - nuevaCant;
    await update(prodRef, { cantidad: stockFinal }).catch(()=>{});
    // actualizar venta
    productos[0].cantidad = nuevaCant;
    productos[0].precio = nuevoPrecio;
    const nuevoTotal = productos.reduce((s, p) => s + (Number(p.cantidad) * Number(p.precio)), 0);
    await set(ventaRef, { ...v, productos, total: nuevoTotal }).catch(()=>{});
    Swal.fire("Venta actualizada", "", "success");
    cerrarModalEditar();
  }, { onlyOnce: true });
});

/* ================================
   IMPRIMIR VENTA (PDF simple)
=================================*/
window.imprimirVenta = async (id) => {
  const ventaRef = ref(db, "ventas_ci/" + id);
  onValue(ventaRef, async (snap) => {
    const v = snap.val();
    if (!v) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text("NOTA DE ENTREGA - CI", 14, 20);
    doc.setFontSize(10);
    doc.text(`Código: ${v.codigo || id}`, 14, 28);
    doc.text(`Fecha: ${v.fecha}`, 14, 34);
    doc.text(`Cliente: ${v.cliente}`, 14, 40);

    const rows = (v.productos || []).map(p => [p.codigo || "-", p.nombre, p.cantidad.toString(), "Q" + Number(p.precio).toFixed(2), "Q" + (p.cantidad * p.precio).toFixed(2)]);
    doc.autoTable({
      head: [["Código", "Producto", "Cant.", "Precio", "Subtotal"]],
      body: rows,
      startY: 48,
    });
    const y = doc.lastAutoTable.finalY + 10;
    doc.text(`Total: Q${Number(v.total).toFixed(2)}`, 140, y);
    doc.save(`nota_${v.codigo || id}.pdf`);
  }, { onlyOnce: true });
};

/* ================================
   BORRAR VENTA (restaurar stock)
=================================*/
window.borrarVenta = (id) => {
  Swal.fire({
    title: "¿Eliminar venta?",
    text: "Se restaurará el stock de los productos.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Sí, eliminar"
  }).then(async (res) => {
    if (!res.isConfirmed) return;
    const ventaRef = ref(db, "ventas_ci/" + id);
    onValue(ventaRef, async (snap) => {
      const v = snap.val();
      if (!v) return;
      // restaurar stock por cada producto
      for (const p of (v.productos || [])) {
        const prodRef = ref(db, "productos_ci/" + p.codigo);
        onValue(prodRef, async (psnap) => {
          const actual = psnap.val() || {};
          const nuevo = (Number(actual.cantidad) || 0) + Number(p.cantidad);
          await update(prodRef, { cantidad: nuevo }).catch(()=>{});
        }, { onlyOnce: true });
      }
      // eliminar venta
      await remove(ventaRef).catch(()=>{});
      Swal.fire("Venta eliminada", "", "success");
    }, { onlyOnce: true });
  });
};

/* ================================
   UTIL: convertir numero a letras (opcional)
=================================*/
function numALetras(numStr) {
  // Implementación corta / simple: (puedes reemplazar por la tuya si la tienes)
  const entero = Math.floor(Number(numStr));
  return entero.toString() + " quetzales";
}

/* ================================
   CERRAR SCRIPT / FIN
=================================*/

/* Nota:
 - Esta parte intenta igualar las funcionalidades principales del archivo "ventas".
 - Para generación de código incremental exacto como en "ventas" (V001, V002...),
   se puede leer todas las ventas y calcular el siguiente número; si lo deseas lo adapto.
 - Si quieres que la edición funcione para todos los productos dentro de una venta
   (y no sólo el primero), dime y lo extiendo en otra petición.
*/
</script>
</body>
</html>

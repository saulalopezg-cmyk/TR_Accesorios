<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ventas CI – TR ACCESORIOS</title>

  <!-- ESTILOS -->
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/sweetalert2.css" />
  <link rel="stylesheet" href="css/material.min.css" />
  <link rel="stylesheet" href="css/material-design-iconic-font.min.css" />
  <link rel="stylesheet" href="css/jquery.mCustomScrollbar.css" />
  <link rel="stylesheet" href="css/main.css" />

  <!-- JS -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>')</script>
  <script src="js/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="js/main.js"></script>
</head>

<body>

<!-- NAV LATERAL -->
<section class="full-width navLateral">
  <div class="full-width navLateral-bg btn-menu"></div>
  <div class="full-width navLateral-body">
    <div class="full-width navLateral-body-logo text-center tittles">
      <i class="zmdi zmdi-close btn-menu"></i> TR ACCESORIOS
    </div>

    <figure class="full-width" style="height: 77px;">
      <div class="navLateral-body-cl">
        <img src="assets/img/logo.jpg" alt="Logo">
      </div>
      <figcaption class="navLateral-body-cr hide-on-tablet">
        <span>Usuario<br><small>Centro de Instalación</small></span>
      </figcaption>
    </figure>
      <nav class="full-width">
        <ul class="full-width list-unstyle menu-principal">
          <li><a href="home_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-view-dashboard"></i></div><div class="navLateral-body-cr hide-on-tablet">Inicio</div></a></li>
          <li><a href="inventory_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-store"></i></div><div class="navLateral-body-cr hide-on-tablet">Inventario</div></a></li>
          <li><a href="client_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-accounts"></i></div><div class="navLateral-body-cr hide-on-tablet">Clientes</div></a></li>
          <li><a href="sales_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-basket"></i></div><div class="navLateral-body-cr hide-on-tablet">Compras</div></a></li>
          <li><a href="providers_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-truck"></i></div><div class="navLateral-body-cr hide-on-tablet">Proveedores</div></a></li>
          <li><a href="ventas_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-cart"></i></div><div class="navLateral-body-cr hide-on-tablet">Ventas</div></a></li>
          <li><a href="cuentas-cobrar_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-balance-wallet"></i></div><div class="navLateral-body-cr hide-on-tablet">Cuentas por cobrar</div></a></li>
         </ul>
    </nav>
  </div>
</section>

<!-- NAV SUPERIOR -->
<div class="full-width navBar">
  <div class="full-width navBar-options">
    <i class="zmdi zmdi-more-vert btn-menu"></i>
  </div>
</div>

<!-- CONTENIDO -->
<section class="full-width pageContent">
  <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">

    <div class="mdl-tabs__tab-bar">
      <a href="#tabNuevaVenta" class="mdl-tabs__tab is-active">Registrar venta – CI</a>
      <a href="#tabHistorial" class="mdl-tabs__tab">Historial de ventas – CI</a>
    </div>

    <!-- NUEVA VENTA -->
    <div class="mdl-tabs__panel is-active" id="tabNuevaVenta">
      <div class="mdl-grid">
        <div class="mdl-cell mdl-cell--8-col mdl-cell--2-offset-desktop">
          <div class="panel mdl-shadow--2dp">

            <div class="panel-tittle bg-primary text-center tittles">
              Registrar venta – Centro de Instalación
            </div>

            <div class="panel-content">
              <form id="formVentaCI">

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <select id="ventaCliente" class="mdl-textfield__input">
                    <option value="">Selecciona un cliente</option>
                  </select>
                </div>

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input list="listaProductos" id="ventaProducto" class="mdl-textfield__input">
                  <label class="mdl-textfield__label">Producto</label>
                  <datalist id="listaProductos"></datalist>
                </div>

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input type="number" id="ventaCantidad" class="mdl-textfield__input">
                  <label class="mdl-textfield__label">Cantidad</label>
                </div>

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input type="number" step="0.01" id="ventaPrecioManual" class="mdl-textfield__input">
                  <label class="mdl-textfield__label">Precio manual (opcional)</label>
                </div>

                <p class="text-center">
                  <button id="btnAgregar" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                    Agregar al carrito
                  </button>
                </p>

              </form>

              <table class="mdl-data-table mdl-js-data-table full-width">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cant.</th>
                    <th>Precio</th>
                    <th>Subtotal</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tablaCarrito"></tbody>
                <tfoot>
                  <tr>
                    <td colspan="3"><strong>Total</strong></td>
                    <td id="ventaTotal">Q0.00</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>

              <p class="text-center">
                <button id="btnFinalizar" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">
                  Finalizar venta – CI
                </button>
              </p>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORIAL -->
    <div class="mdl-tabs__panel" id="tabHistorial">
      <div id="listaVentas" class="mdl-list"></div>
    </div>

  </div>
</section>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getDatabase, ref, get, push, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCE9UY3P3oEFZ_cgX7d5Ox0lFZiL_9Uszs",
  authDomain: "accesoriostr-7f01e.firebaseapp.com",
  databaseURL: "https://accesoriostr-7f01e-default-rtdb.firebaseio.com",
  projectId: "accesoriostr-7f01e",
  storageBucket: "accesoriostr-7f01e.firebasestorage.app",
  messagingSenderId: "927871540022",
  appId: "1:927871540022:web:eb4a9a446cc0a6530a7197"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const clienteSel = document.getElementById("ventaCliente");
const productoInput = document.getElementById("ventaProducto");
const listaProductos = document.getElementById("listaProductos");
const cantidadInput = document.getElementById("ventaCantidad");
const precioManualInput = document.getElementById("ventaPrecioManual");
const tabla = document.getElementById("tablaCarrito");
const totalTxt = document.getElementById("ventaTotal");
const listaVentas = document.getElementById("listaVentas");

let productos = {};
let carrito = [];

/* CLIENTES */
get(ref(db,"clientes")).then(s=>{
  const d=s.val()||{};
  Object.entries(d).forEach(([id,c])=>{
    const o=document.createElement("option");
    o.value=id;
    o.textContent=`${c.nombre} ${c.apellido||""}`;
    clienteSel.appendChild(o);
  });
});

/* PRODUCTOS CI */
get(ref(db,"productos_ci")).then(s=>{
  productos=s.val()||{};
  Object.entries(productos).forEach(([id,p])=>{
    const o=document.createElement("option");
    o.value=`${id} - ${p.nombre}`;
    listaProductos.appendChild(o);
  });
});

/* AGREGAR */
document.getElementById("btnAgregar").onclick=e=>{
  e.preventDefault();

  const texto=productoInput.value.trim();
  const cant=parseInt(cantidadInput.value);
  const precioManual=parseFloat(precioManualInput.value);

  if(!texto||!cant||cant<=0){
    Swal.fire("Datos inválidos","","warning");return;
  }

  const codigo=texto.split(" - ")[0];
  const prod=productos[codigo];
  let precio=prod?.precioSugerido||0;

  if(!isNaN(precioManual)&&precioManual>0){
    precio=precioManual;
  }

  carrito.push({
    codigo,
    nombre:prod?prod.nombre:texto,
    cantidad:cant,
    precio,
    isCustom:!prod
  });

  render();
  productoInput.value="";
  cantidadInput.value="";
  precioManualInput.value="";
};

/* RENDER */
function render(){
  tabla.innerHTML="";
  let total=0;
  carrito.forEach((p,i)=>{
    const sub=p.cantidad*p.precio;
    total+=sub;
    tabla.innerHTML+=`
      <tr>
        <td>${p.nombre}</td>
        <td>${p.cantidad}</td>
        <td>Q${p.precio.toFixed(2)}</td>
        <td>Q${sub.toFixed(2)}</td>
        <td><button onclick="window.del(${i})">❌</button></td>
      </tr>`;
  });
  totalTxt.textContent=`Q${total.toFixed(2)}`;
}
window.del=i=>{carrito.splice(i,1);render()};

/* FINALIZAR */
document.getElementById("btnFinalizar").onclick=async()=>{
  if(carrito.length===0)return;

  const venta={
    cliente:clienteSel.value,
    fecha:new Date().toISOString().split("T")[0],
    productos:carrito,
    total:carrito.reduce((s,p)=>s+p.cantidad*p.precio,0)
  };

  await set(push(ref(db,"ventas_ci")),venta);

  for(const p of carrito){
    if(!p.isCustom){
      await update(ref(db,"productos_ci/"+p.codigo),{
        cantidad:productos[p.codigo].cantidad-p.cantidad
      });
    }
  }

  Swal.fire("Venta CI registrada","","success");
  carrito=[];
  render();
};

/* HISTORIAL */
onValue(ref(db,"ventas_ci"),snap=>{
  listaVentas.innerHTML="";
  const d=snap.val()||{};
  Object.values(d).forEach(v=>{
    listaVentas.innerHTML+=`
      <div class="mdl-list__item">
        <span class="mdl-list__item-primary-content">
          <i class="zmdi zmdi-receipt"></i>
          <span>Q${v.total.toFixed(2)} – ${v.fecha}</span>
        </span>
      </div>`;
  });
});
</script>

<script src="js/menu.js"></script>
</body>
</html>

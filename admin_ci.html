<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administración de Usuarios – TR Accesorios</title>
  <!-- Estilos -->
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/sweetalert2.css" />
  <link rel="stylesheet" href="css/material.min.css" />
  <link rel="stylesheet" href="css/material-design-iconic-font.min.css" />
  <link rel="stylesheet" href="css/jquery.mCustomScrollbar.css" />
  <link rel="stylesheet" href="css/main.css" />
  <!-- Scripts base -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>')</script>
  <script src="js/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="js/main.js"></script>
</head>
<body>
  <!-- Navbar -->
  <div class="full-width navBar">
    <div class="full-width navBar-options">
      <i class="zmdi zmdi-more-vert btn-menu" id="btn-menu"></i>
      <nav class="navBar-options-list">
        <ul class="list-unstyle">
          <li class="btn-exit" onclick="logout()"><i class="zmdi zmdi-power"></i></li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Barra lateral -->
  <section class="full-width navLateral">
    <div class="full-width navLateral-bg btn-menu"></div>
    <div class="full-width navLateral-body">
      <div class="full-width navLateral-body-logo text-center tittles">
        <i class="zmdi zmdi-close btn-menu"></i> TR ACCESORIOS
      </div>
      <figure class="full-width" style="height: 77px;">
        <div class="navLateral-body-cl">
          <img src="assets/img/logo.jpg" alt="Avatar" class="img-responsive" />
        </div>
        <figcaption class="navLateral-body-cr hide-on-tablet">
          <span>
            Usuario<br />
            <small>Rol</small>
          </span>
        </figcaption>
      </figure>
      <div class="full-width tittles navLateral-body-tittle-menu">
        <i class="zmdi zmdi-desktop-mac"></i><span class="hide-on-tablet"> MENÚ</span>
      </div>
      <nav class="full-width">
        <ul class="full-width list-unstyle menu-principal">
          <li><a href="home_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-view-dashboard"></i></div><div class="navLateral-body-cr hide-on-tablet">Inicio</div></a></li>
          <li><a href="ventas_ci.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-cart"></i></div><div class="navLateral-body-cr hide-on-tablet">Ventas</div></a></li>
          <li><a href="admin_ci.html" class="full-width active"><div class="navLateral-body-cl"><i class="zmdi zmdi-accounts-alt"></i></div><div class="navLateral-body-cr hide-on-tablet">Administradores</div></a></li>
		<li><a href="bitacora_ci.html" class="full-width active"><div class="navLateral-body-cl"><i class="zmdi zmdi-assignment"></i></div><div class="navLateral-body-cr hide-on-tablet">Bitácora</div></a></li>  
		</ul>
      </nav>
    </div>
  </section>

  <!-- Contenido -->
  <section class="full-width pageContent">
    <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
      <div class="mdl-tabs__tab-bar">
        <a href="#tabNuevoUsuario" class="mdl-tabs__tab is-active">Registrar usuario</a>
        <a href="#tabListaUsuarios" class="mdl-tabs__tab">Lista de usuarios</a>
      </div>

      <!-- Aquí irán las pestañas de contenido -->
	   <div class="mdl-tabs__panel is-active" id="tabNuevoUsuario">
  <div class="mdl-grid">
    <div class="mdl-cell mdl-cell--8-col mdl-cell--2-offset-desktop">
      <div class="full-width panel mdl-shadow--2dp">
        <div class="full-width panel-tittle bg-primary text-center tittles">Registrar nuevo usuario</div>
        <div class="full-width panel-content">
          <form id="formRegistroUsuario">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <input class="mdl-textfield__input" type="text" id="usuarioNombre" />
              <label class="mdl-textfield__label" for="usuarioNombre">Nombre completo</label>
            </div>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <input class="mdl-textfield__input" type="email" id="usuarioCorreo" />
              <label class="mdl-textfield__label" for="usuarioCorreo">Correo electrónico</label>
            </div>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <input class="mdl-textfield__input" type="password" id="usuarioClave" />
              <label class="mdl-textfield__label" for="usuarioClave">Contraseña</label>
            </div>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <select class="mdl-textfield__input" id="usuarioRol">
                <option value="">Seleccione un rol</option>
                <option value="admin">Administrador</option>
                <option value="vendedor">Vendedor</option>
              </select>
              <label class="mdl-textfield__label" for="usuarioRol"></label>
            </div>
            <p class="text-center">
              <button id="btnCrearUsuario" type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                Crear usuario
              </button>
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lista de usuarios -->
<div class="mdl-tabs__panel" id="tabListaUsuarios">
  <div class="mdl-grid">
    <div class="mdl-cell mdl-cell--10-col mdl-cell--1-offset-desktop">
      <div class="full-width panel mdl-shadow--2dp">
        <div class="full-width panel-tittle bg-success text-center tittles">Usuarios registrados</div>
        <div class="full-width panel-content">
          <input type="text" id="filtroUsuarios" class="mdl-textfield__input" placeholder="Buscar por nombre o correo..." style="margin-bottom:15px;width:50%;" />
          <ul class="mdl-list" id="listaUsuarios">
            <!-- Usuarios cargados desde Firebase -->
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import {
    getDatabase, ref, set, get, onValue, remove, update
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
  import {
    getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  const firebaseConfig = {
  apiKey: "AIzaSyCE9UY3P3oEFZ_cgX7d5Ox0lFZiL_9Uszs",
  authDomain: "accesoriostr-7f01e.firebaseapp.com",
  databaseURL: "https://accesoriostr-7f01e-default-rtdb.firebaseio.com",
  projectId: "accesoriostr-7f01e",
  storageBucket: "accesoriostr-7f01e.firebasestorage.app",
  messagingSenderId: "927871540022",
  appId: "1:927871540022:web:eb4a9a446cc0a6530a7197"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  window.logout = function () {
    signOut(auth).then(() => window.location.href = "index.html");
  };

  onAuthStateChanged(auth, user => {
    if (!user) return window.location.href = "index.html";

    get(ref(db, "usuarios/" + user.uid)).then(snap => {
      const datos = snap.val() || {};
      if (datos.rol !== "admin") {
        Swal.fire("Acceso restringido", "Solo para administradores", "error")
          .then(() => window.location.href = "home_ci.html");
      }

      const spanInfo = `${user.email}<br><small>${datos.rol || ""}</small>`;
      document.querySelectorAll(".navLateral-body-cr span").forEach(el => el.innerHTML = spanInfo);
    });
  });

  const form = document.getElementById("formRegistroUsuario");
  form.addEventListener("submit", e => {
    e.preventDefault();

    const nombre = document.getElementById("usuarioNombre").value.trim();
    const correo = document.getElementById("usuarioCorreo").value.trim();
    const clave = document.getElementById("usuarioClave").value.trim();
    const rol = document.getElementById("usuarioRol").value;

    if (!nombre || !correo || !clave || !rol) {
      Swal.fire("Todos los campos son obligatorios", "", "warning");
      return;
    }

    createUserWithEmailAndPassword(auth, correo, clave).then(creado => {
      const uid = creado.user.uid;
      const usuario = { nombre, correo, rol, creado: new Date().toISOString().split("T")[0] };
      return set(ref(db, "usuarios/" + uid), usuario);
    }).then(() => {
      Swal.fire("Usuario creado", "", "success");
      form.reset();
      document.querySelectorAll(".mdl-textfield").forEach(el => el.classList.remove("is-dirty"));
    }).catch(err => {
      Swal.fire("Error", err.message, "error");
    });
  });

  const lista = document.getElementById("listaUsuarios");
  const filtro = document.getElementById("filtroUsuarios");
  let todos = {};

  onValue(ref(db, "usuarios"), snap => {
    todos = snap.val() || {};
    renderizarUsuarios();
  });

  function renderizarUsuarios() {
    lista.innerHTML = "";
    const texto = filtro.value.trim().toLowerCase();

    Object.entries(todos).forEach(([id, u]) => {
      const nombre = u.nombre || "";
      const correo = u.correo || "";
      const coincide = nombre.toLowerCase().includes(texto) || correo.toLowerCase().includes(texto);
      if (!coincide) return;

      const li = document.createElement("li");
      li.className = "mdl-list__item";
      li.innerHTML = `
        <span class="mdl-list__item-primary-content">
          <strong>${nombre}</strong><br>${correo} (${u.rol})
        </span>
        <span class="mdl-list__item-secondary-action">
          <button onclick="editarUsuario('${id}')" class="mdl-button mdl-button--icon"><i class="zmdi zmdi-edit"></i></button>
          <button onclick="eliminarUsuario('${id}')" class="mdl-button mdl-button--icon"><i class="zmdi zmdi-delete"></i></button>
        </span>
      `;
      lista.appendChild(li);
    });
  }

  filtro.addEventListener("input", renderizarUsuarios);

  window.eliminarUsuario = function (id) {
    Swal.fire({
      title: "¿Eliminar usuario?",
      text: "Esta acción no puede deshacerse",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Sí, eliminar"
    }).then(r => {
      if (!r.isConfirmed) return;
      remove(ref(db, "usuarios/" + id)).then(() =>
        Swal.fire("Usuario eliminado", "", "success")
      );
    });
  };

  window.editarUsuario = function (id) {
    const u = todos[id];
    Swal.fire({
      title: "Editar usuario",
      html: `
        <input id="editNombre" class="swal2-input" placeholder="Nombre" value="${u.nombre || ""}">
        <input id="editRol" class="swal2-input" placeholder="Rol (admin/vendedor)" value="${u.rol || ""}">
      `,
      focusConfirm: false,
      preConfirm: () => {
        return {
          nombre: document.getElementById("editNombre").value,
          rol: document.getElementById("editRol").value
        };
      },
      showCancelButton: true
    }).then(res => {
      if (!res.isConfirmed) return;
      const { nombre, rol } = res.value;
      update(ref(db, "usuarios/" + id), { nombre, rol }).then(() => {
        Swal.fire("Usuario actualizado", "", "success");
      });
    });
  };
</script>
</body>
</html>